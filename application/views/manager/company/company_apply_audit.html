{{include file='manager/public/head.html'}}
<body class="no-skin">
{{include file='manager/public/header.html'}}
<link rel="stylesheet" href="/manager_statics/app/lightbox.min.css?v2"/>
<style>
    #uploadImgcontainer li{
        list-style: none;
        float: left;
        position: relative;
        margin-bottom: 10px;
        margin-right: 10px;
    }
</style>
<div class="main-container" id="main-container">
    <script type="text/javascript">
        try {
            ace.settings.check('main-container', 'fixed')
        } catch (e) {
        }
    </script>
    <style>
        pre {outline: 1px solid #ccc; padding: 5px; margin: 5px; }
        .string { color: green; }
        .number { color: darkorange; }
        .boolean { color: blue; }
        .null { color: magenta; }
        .key { color: red; }
    </style>
    {{include file='manager/public/sidebar.html'}}
    <div class="main-content">
        <div class="main-content-inner">
            <!-- #section:basics/content.breadcrumbs -->
            {{include file='manager/public/breadcrumbs.html'}}

            <!-- /section:basics/content.breadcrumbs -->
            <div class="page-content">
                {{include file='manager/public/set.html'}}

                <!-- /section:settings.box -->
                <div class="row">
                    <div class="col-xs-12">
                        <form id="delete_form" method="post" action="/manager/company_pending_cancel">
                 <input type="hidden" name="company_id" value="{{$data.id|default:''}}">
            </form>
                        <!-- PAGE CONTENT BEGINS -->
                        <form id="save_form" class="form-horizontal" role="form" action="/manager/company_pending_pass" method="post">
                            <input type="hidden" name="folder" value="{{$time}}" id="folder">
                            <input type="hidden" id="company_id" name="company_id" value="{{$data.id|default:''}}">
                           <div class="tabbable">
                                    <ul class="nav nav-tabs padding-18 tab-size-bigger" id="myTab">
                                        <li class="active">
                                            <a data-toggle="tab" href="#faq-tab-1">
                                                <i class="blue ace-icon fa fa-question-circle bigger-120"></i>
                                                企业基本信息
                                            </a>
                                        </li>

                                        <li>
                                            <a data-toggle="tab" href="#faq-tab-2">
                                                <i class="green ace-icon fa fa-user bigger-120"></i>
                                                执业经纪人
                                            </a>
                                        </li>
                                    </ul>

                                    <div class="tab-content no-border padding-24">
                                        <div id="faq-tab-1" class="tab-pane fade in active">
                                            <h4 class="blue">
                                                <i class="green ace-icon fa fa-list bigger-110"></i>
                                               企业信息
                                            </h4>

                                            <div class="space-8"></div>
                                            <div class="form-group">
                                                <label class="col-sm-1 control-label no-padding-right" for="company_name"> 企业名称 </label>
                                                <div class="col-sm-9">
                                                    <input type="text" id="company_name" name="company_name" class="rcol-xs-10 col-sm-5" value="{{$data.company_name|default:''}}">
                                                    <span class="help-inline col-xs-12 col-sm-7"></span>
                                                </div>
                                            </div>
                                            <div class="space-4"></div>
                                        <div class="form-group">
                                             <label class="col-sm-1 control-label no-padding-right" for="business_no"> 统一社会信用代码 </label>
                                        <div class="col-sm-9">
                                        <input type="text" id="business_no" name="business_no" class="rcol-xs-10 col-sm-5 js4ABC_num" value="{{$data.business_no|default:''}}">
                                            <span class="help-inline col-xs-12 col-sm-7"></span>
                                            </div>
                                        </div>
                                            <div class="space-4"></div>
                                            <div class="form-group">
                                                <label class="col-sm-1 control-label no-padding-right" for="register_path"> 注册地址 </label>
                                                <div class="col-sm-9">
                                                    <input type="text" id="register_path" name="register_path" class="rcol-xs-10 col-sm-5" value="{{$data.register_path|default:''}}">
                                                    <span class="help-inline col-xs-12 col-sm-7"></span>
                                                </div>
                                            </div>
                                            <div class="space-4"></div>
                                            <div class="form-group">
                                                <label class="col-sm-1 control-label no-padding-right" for="business_path"> 经营地址 </label>
                                                <div class="col-sm-9">
                                                    <input type="text" id="business_path" name="business_path" class="rcol-xs-10 col-sm-5" value="{{$data.business_path|default:''}}">
                                                    <span class="help-inline col-xs-12 col-sm-7"></span>
                                                </div>
                                            </div>
                                        <!--<div class="space-4"></div>

                                         <div class="form-group">
                                             <label class="col-sm-1 control-label no-padding-right" for="record_num"> 备案号 </label>
                                       <div class="col-sm-9 yy_m_7">
                                           {{$data.record_num|default:''}}
                                            </div>
                                        </div>
                                    
                                        <div class="space-4"></div>

                                            <div class="form-group">
                                                <label class="col-sm-1 control-label no-padding-right" for="issuing_date"> 发证日期 </label>
                                                <div class="col-sm-9">
                                                    <input type="text" onfocus="WdatePicker({isShowClear:true,readOnly:true,dateFmt:'yyyy-MM-dd'})"  id="issuing_date" name="issuing_date" class="rcol-xs-10 col-sm-5" value="{{$data.issuing_date|default:''}}">
                                                    <span class="help-inline col-xs-12 col-sm-7"></span>
                                                </div>
                                            </div>-->
                                            <div class="space-4"></div>

                                            <div class="form-group">
                                                <label class="col-sm-1 control-label no-padding-right" for="company_phone"> 企业电话 </label>
                                                <div class="col-sm-9">
                                                    <input type="text" id="company_phone" name="company_phone"  class="rcol-xs-10 col-sm-5" value="{{$data.company_phone|default:''}}">
                                                    <span class="help-inline col-xs-12 col-sm-7"></span>
                                                </div>
                                            </div>
                                            <div class="space-4"></div>

                                            <div class="form-group">
                                                <label class="col-sm-1 control-label no-padding-right" for="director_name"> 负责人姓名 </label>
                                                <div class="col-sm-9">
                                                    <input type="text" id="director_name" name="director_name"  class="rcol-xs-10 col-sm-5" value="{{$data.director_name|default:''}}">
                                                    <span class="help-inline col-xs-12 col-sm-7"></span>
                                                </div>
                                            </div>
                                            <div class="space-4"></div>

                                            <div class="form-group">
                                                <label class="col-sm-1 control-label no-padding-right" for="director_phone"> 负责人电话 </label>
                                                <div class="col-sm-9">
                                                    <input type="text" id="director_phone" name="director_phone"  class="rcol-xs-10 col-sm-5" value="{{$data.director_phone|default:''}}">
                                                    <span class="help-inline col-xs-12 col-sm-7"></span>
                                                </div>
                                            </div>
                                        <div class="space-4"></div>
                                             <h4 class="blue">
                                                <i class="green ace-icon fa fa-list bigger-110"></i>
                                               法人信息
                                            </h4>

                                            <div class="space-8"></div>
                                            <div class="form-group">
                                                <label class="col-sm-1 control-label no-padding-right" for="legal_name"> 法人姓名 </label>
                                                <div class="col-sm-9">
                                                    <input type="text" id="legal_name" name="legal_name"  class="rcol-xs-10 col-sm-5" value="{{$data.legal_name|default:''}}">
                                                    <span class="help-inline col-xs-12 col-sm-7"></span>
                                                </div>
                                            </div>
                                            <div class="space-4"></div>
                                            <div class="form-group">
                                                <label class="col-sm-1 control-label no-padding-right" for="legal_phone"> 法人电话 </label>
                                                <div class="col-sm-9">
                                                    <input type="text" id="legal_phone" name="legal_phone"  class="rcol-xs-10 col-sm-5" value="{{$data.legal_phone|default:''}}">
                                                    <span class="help-inline col-xs-12 col-sm-7"></span>
                                                </div>
                                            </div>
                                            <div class="space-4"></div>
                                            <h4 class="blue">
                                                <i class="green ace-icon fa fa-list bigger-110"></i>
                                                上传图片
                                            </h4>

                                            <div class="space-8"></div>

                                            <div class="form-group">

                                                <div class="col-sm-9">
                                                    <a href="javascript:" class="btn btn-white btn-xs btn-primary" onclick="triggerFileUpload(1)">上 传</a>


                                                </div>

                                            </div>
                                            <div class="form-group">


                                                <div class="col-sm-10">

                                                    <ul id="uploadImgcontainer" style="width: 95%">
                                                        {{if !empty($data.img) }}
                                                        {{foreach from=$data.img item=item}}
                                                        <li>
                                                            <img src="{{$item.img_path}}?imageView2/0/w/200/h/200/q/75|imageslim" alt="" style="height: 120px">
                                                            <span class="delete-this" onclick="del_pic(this);"><i></i></span>
                                                            <input type="hidden" name="pic_short[]" class="pic_short" value="{{$item.img_path}}">

                                                        </li>
                                                        {{/foreach}}
                                                        {{/if}}
                                                    </ul>

                                                </div>

                                            </div>

                                        </div>

                                        <div id="faq-tab-2" class="tab-pane fade">
                                            <h4 class="blue">
                                                <i class="green ace-icon fa fa-user bigger-110"></i>
                                                执业经纪人
                                            </h4>

                                            <div class="space-8"></div>
                                             <div class="form-group">
                                           
                                        <div class="col-sm-9">
                                             <table class="table table-striped table-bordered">

                                <thead>

                                <tr>

                                    <th style="width:15%;">姓名</th>
                                    <th style="width:20%;">从业编号</th>
                                    <th style="width:20%;">执业证号</th>

                                    <th style="width:25%;">身份证号</th>
                                    <th style="width:15%;">联系电话</th>
                                    <th style="width:10%;">网签</th>
                                </tr>

                                </thead>

                                <tbody id="tbody_id">
                                    {{if !empty($data.agent) }}
                            {{foreach from=$data.agent item=item}}
                            <tr>
                                        <td>{{if $item.work_type == 1}}<span class="label label-warning label-white middle">持证</span>{{/if}}{{$item.name}}</td>
                                <td>{{$item.job_num}}</td>
                                        <td>{{$item.job_code}}</td>
                                          <td>{{$item.card}}</td>
                                            <td>{{$item.phone}}</td>
                                            <td>
                                                <input type="hidden" name="setwq[]" value="{{if $item.wq == 2}}2{{else}}1{{/if}}">
                                                <input class="agent_flag_" readonly="readonly" disabled="disabled" name="ckwq[]" {{if $item.wq == 2}} checked{{/if}} type="checkbox" />
                                            </td>
                                    </tr>
                            {{/foreach}}
                            {{/if}}
                                  
                                </tbody>
                            </table>
                                            </div>
                                        </div>
                          
                                         
                                        </div>
                        
                                    </div>
                                </div>

                      

                            <div class="col-md-offset-2 col-md-9">
                                <button id="save_btn" class="btn btn-info" type="button">

                                    <i class="icon-ok bigger-110"></i>

                                    提 审

                                </button>
                                &nbsp; &nbsp; &nbsp;
                                <a href="/manager/company_pending_list" class="btn" type="reset">

                                    <i class="icon-undo bigger-110"></i>

                                    返 回

                                </a>
                            </div>
                        </form>
                        <!-- PAGE CONTENT ENDS -->
                    </div><!-- /.col -->
                </div><!-- /.row -->
            </div><!-- /.page-content -->
        </div>
    </div><!-- /.main-content -->
    {{include file='manager/public/footer.html'}}

</div><!-- /.main-container -->

{{include file='manager/public/footerjs.html'}}
<!-- inline scripts related to this page -->
<!--plupload start--------------------------------------------------------------------------->
<!-- Load plupload and all it's runtimes and finally the UI widget -->
<link rel="stylesheet" href="/manager_statics/plupload/js/jquery.ui.plupload/css/jquery.ui.plupload.css" type="text/css" />
<!-- production -->
<script type="text/javascript" src="/manager_statics/plupload/js/plupload.full.min.js"></script>
<script type="text/javascript" src="/manager_statics/plupload/js/zh_CN.js"></script>
<script type="text/javascript" src="/manager_statics/plupload/js/jquery.ui.plupload/jquery.ui.plupload.js"></script>
<!--plupload END--------------------------------------------------------------------------->


<script src="/manager_statics/app/ajaxfileupload.js"></script>

<script type="text/javascript">


    function triggerFileUpload(flag) {
        var data_ = "{{$f_user_id}}_{{$time}}_" + flag.toString() + "_" +  Math.floor(Math.random()*(9000)+1000);
        $("#folder").val(data_);
        var html = '<div id="uploader" style="width:550px;"><p>Your browser doesn\'t have Flash, Silverlight or HTML5 support.</p></div>';

        var layerIndex = layer.confirm(html, {
            offset: ['100px', (document.body.offsetWidth - 800) / 2],
            maxWidth: 800,
            btn: ['确定','取消'],
            shade: false
        }, function(){
            uploadFile(flag);
            layer.close(layerIndex);
        }, function(){
        });

        $("#uploader").plupload({
            runtimes : 'html5,flash,silverlight',
            url : "/manager_login/save_pics/company_pic/" + $("#folder").val(),
            max_file_size : '50mb',
            resize : { crop: true },
            file_data_name: 'userfile',
            filters : [],
            filters: {
                mime_types : [{
                    title : "Image files",
                    extensions : "jpg,gif,png,jpeg"
                }],
                max_file_size : '8024kb',
                prevent_duplicates : true
            },
            rename: true,
            sortable: true,
            dragdrop: true,
            views: {
                list: true,
                thumbs: true,
                active: 'thumbs'
            },
            flash_swf_url : '/manager_statics/plupload/js/Moxie.swf',
            silverlight_xap_url : '/manager_statics/plupload/js/Moxie.xap'
        });
    }

    function uploadFile(flag) {
        if ($('#uploader').plupload('getFiles').length < 1) {
            alert("图片未上传,请重新选择.");
            return false;
        } else {
            $.getJSON("/manager_login/get_pics/company_pic/" + $("#folder").val() +  "/?_=" + Math.random(), function(data){
                var html = '';
                var now_pic = [];
                $('input[name="pic_short[]"]').each(function(index){
                    now_pic[index] = $(this).val();
                });

                $.each(data.img,function(index,item){
                    var path = item + '?imageView2/0/w/200/h/200/q/75|imageslim';
                    if($.inArray(item, now_pic) < 0){
                        html += '<li><img src="' + path + '" alert="" style="height: 120px" />';
                        html += '<span class="delete-this" onclick="del_pic(this);"><i></i></span>';
                        html += '<input type="hidden" name="pic_short[]" class="pic_short" value="' + item + '">';
                        //html += '<input type="hidden" name="folder[]" value="'+ $("#folder").val() +'">';
                        html += '</li>';
                    }
                });
                $("#uploadImgcontainer").append(html);

            });
            return true;
        }
    }

    function del_pic(obj) {
        $(obj).parent().remove();
    }



    $("#save_btn").click(function(){
        var company_id = $("#company_id").val();
        $.post('/ajax_api/check_company_ns_pass',{company_id: company_id}, function(html){
            if(html == 1){
                submit_fun('/manager/company_pending_pass');
            }else{
                var layerIndex = layer.confirm('此企业已存在本年度年审通过记录,是否继续提交?', {
                    btn: ['确定','取消'], //按钮
                    area: ['300px', 'auto']
                }, function(){
                    layer.close(layerIndex);
                    submit_fun('/manager/company_pending_pass');
                },function(){

                });
            }
        });

    })
    function submit_fun(url_submit){
        var index_load = layer.load(1, {
            shade: [0.1,'#fff'] //0.1透明度的白色背景
        });
        var flag = -1;
        var company_name = $.trim($("#company_name").val());
        if(company_name == "" ) {
            layer.close(index_load);
            layer.msg('企业名称不能为空', {icon: 2});
            return false;
        }
        var business_no = $.trim($("#business_no").val());
        if(business_no == "" ) {
            layer.close(index_load);
            layer.msg('统一社会信用代码不能为空', {icon: 2});
            return false;
        }
        var register_path = $.trim($("#register_path").val());
        if(register_path == "" ) {
            layer.close(index_load);
            layer.msg('注册地址不能为空', {icon: 2});
            return false;
        }
        var business_path = $.trim($("#business_path").val());
        if(business_path == "" ) {
            //layer.close(index_load);
            //layer.msg('经营地址不能为空', {icon: 2});
            //return false;
        }
        var issuing_date = $.trim($("#issuing_date").val());
        if(issuing_date == "" ) {
            //layer.close(index_load);
            //layer.msg('发证日期不能为空', {icon: 2});
            //return false;
        }

        var company_phone = $.trim($("#company_phone").val());
        if(company_phone == "" ) {
            layer.close(index_load);
            layer.msg('企业电话不能为空', {icon: 2});
            return false;
        }
        var director_name = $.trim($("#director_name").val());
        if(director_name == "" ) {
            layer.close(index_load);
            layer.msg('负责人姓名不能为空', {icon: 2});
            return false;
        }
        var director_phone = $.trim($("#director_phone").val());
        if(director_phone == "" ) {
            layer.close(index_load);
            layer.msg('负责人电话不能为空', {icon: 2});
            return false;
        }
        var legal_name = $.trim($("#legal_name").val());
        if(legal_name == "" ) {
            layer.close(index_load);
            layer.msg('法人姓名不能为空', {icon: 2});
            return false;
        }
        var legal_phone = $.trim($("#legal_phone").val());
        if(legal_phone == "" ) {
            layer.close(index_load);
            layer.msg('法人电话不能为空', {icon: 2});
            return false;
        }
        //报备时可以随意修改 审核时再做判断，以免在审核中有人员变动
        var length = $("#tbody_id").find(".agent_flag_").length;
        if(length < 3){
            layer.close(index_load);
            layer.msg('年审提审时,持证经纪人不能小于三个!', {icon: 2});
            flag=1;return false;
        }
        if(flag != 1){
            var form = document.getElementById('save_form');

            var formdata = new FormData(form);
            $.ajax({
                type : "POST",
                url : url_submit,
                data : formdata,
                async: true,
                cache: false,
                contentType: false,
                processData: false,
                success : function(data) {
                    layer.close(index_load);
                    var return_ = JSON.parse(data)
                    if(return_.status == 1){
                        var url = '/manager/company_pending_list/';
                        layer.alert('操作成功!', {
                            skin: 'layui-layer-molv' //样式类名
                            ,closeBtn: 0
                        }, function(){
                            window.location.replace(url);
                        });
                    }else{
                        layer.msg(return_.msg);
                    }
                },
                error:function(){
                    layer.close(index_load);
                    layer.msg('网络异常!');
                }
            });
        }else{
            layer.close(index_load);
        }

    }
</script>
</body>
</html>
