{{include file='manager/public/head.html'}}
<body class="no-skin">
{{include file='manager/public/header.html'}}
<style>
    #uploadImgcontainer li{
        list-style: none;
        float: left;
        position: relative;
        margin-bottom: 10px;
        margin-right: 10px;
    }
</style>
<div class="main-container" id="main-container">
    <script type="text/javascript">
        try {
            ace.settings.check('main-container', 'fixed')
        } catch (e) {
        }
    </script>
    <style>
        pre {outline: 1px solid #ccc; padding: 5px; margin: 5px; }
        .string { color: green; }
        .number { color: darkorange; }
        .boolean { color: blue; }
        .null { color: magenta; }
        .key { color: red; }
    </style>
    {{include file='manager/public/sidebar.html'}}
    <div class="main-content">
        <div class="main-content-inner">
            <!-- #section:basics/content.breadcrumbs -->
            {{include file='manager/public/breadcrumbs.html'}}

            <!-- /section:basics/content.breadcrumbs -->
            <div class="page-content">
                {{include file='manager/public/set.html'}}

                <!-- /section:settings.box -->
                <div class="row">
                    <div class="col-xs-12">
                        <!-- PAGE CONTENT BEGINS -->
                        <form id="save_form" class="form-horizontal" role="form" action="/manager/company_pending_3_save" method="post">
                            <input type="hidden" name="folder" value="{{$time}}" id="folder">
                            <input type="hidden" name="company_id" value="{{$data.id|default:''}}">
                           <div class="tabbable">
                                    <ul class="nav nav-tabs padding-18 tab-size-bigger" id="myTab">
                                        <li class="active">
                                            <a data-toggle="tab" href="#faq-tab-1">
                                                <i class="blue ace-icon fa fa-question-circle bigger-120"></i>
                                                企业基本信息
                                            </a>
                                        </li>

                                        <li>
                                            <a data-toggle="tab" href="#faq-tab-2">
                                                <i class="green ace-icon fa fa-user bigger-120"></i>
                                                执业经纪人
                                            </a>
                                        </li>
                                    </ul>

                                    <div class="tab-content no-border padding-24">
                                        <div id="faq-tab-1" class="tab-pane fade in active">
                                            <h4 class="blue">
                                                <i class="green ace-icon fa fa-list bigger-110"></i>
                                               企业信息
                                            </h4>

                                            <div class="space-8"></div>
                                        <div class="form-group">
                                             <label class="col-sm-1 control-label no-padding-right" for="company_name"> 企业名称 </label>
                                        <div class="col-sm-9">
                                        <input type="text" id="company_name" name="company_name" class="rcol-xs-10 col-sm-5" value="{{$data.company_name|default:''}}">
                                            <span class="help-inline col-xs-12 col-sm-7"></span>
                                            </div>
                                        </div>
                                        <div class="space-4"></div>
                                     <div class="form-group">
                                             <label class="col-sm-1 control-label no-padding-right" for="register_path"> 注册地址 </label>
                                        <div class="col-sm-9">
                                        <input type="text" id="register_path" name="register_path" class="rcol-xs-10 col-sm-5" value="{{$data.register_path|default:''}}">
                                            <span class="help-inline col-xs-12 col-sm-7"></span>
                                            </div>
                                        </div>
                                        <div class="space-4"></div>
                                         <div class="form-group">
                                             <label class="col-sm-1 control-label no-padding-right" for="business_path"> 经营地址 </label>
                                        <div class="col-sm-9">
                                        <input type="text" id="business_path" name="business_path" class="rcol-xs-10 col-sm-5" value="{{$data.business_path|default:''}}">
                                            <span class="help-inline col-xs-12 col-sm-7"></span>
                                            </div>
                                        </div>
                                         <div class="space-4"></div>
                                         <div class="form-group">
                                             <label class="col-sm-1 control-label no-padding-right"> 备案号 </label>
                                        <div class="col-sm-9 yy_m_7">
                                       {{$data.record_num|default:''}}
                                            </div>
                                        </div>
                                        <div class="space-4"></div>

                                         <div class="form-group">
                                             <label class="col-sm-1 control-label no-padding-right" for="issuing_date"> 发证日期 </label>
                                        <div class="col-sm-9">
                                        <input type="text" onfocus="WdatePicker({isShowClear:true,readOnly:true,dateFmt:'yyyy-MM-dd'})"  id="issuing_date" name="issuing_date" class="rcol-xs-10 col-sm-5" value="{{$data.issuing_date|default:''}}">
                                            <span class="help-inline col-xs-12 col-sm-7"></span>
                                            </div>
                                        </div>
                                        <div class="space-4"></div>

                                         <div class="form-group">
                                             <label class="col-sm-1 control-label no-padding-right" for="company_phone"> 企业电话 </label>
                                        <div class="col-sm-9">
                                        <input type="text" id="company_phone" name="company_phone"  class="rcol-xs-10 col-sm-5" value="{{$data.company_phone|default:''}}">
                                            <span class="help-inline col-xs-12 col-sm-7"></span>
                                            </div>
                                        </div>
                                        <div class="space-4"></div>

                                         <div class="form-group">
                                             <label class="col-sm-1 control-label no-padding-right" for="director_name"> 负责人姓名 </label>
                                        <div class="col-sm-9">
                                        <input type="text" id="director_name" name="director_name"  class="rcol-xs-10 col-sm-5" value="{{$data.director_name|default:''}}">
                                            <span class="help-inline col-xs-12 col-sm-7"></span>
                                            </div>
                                        </div>
                                        <div class="space-4"></div>

                                         <div class="form-group">
                                             <label class="col-sm-1 control-label no-padding-right" for="director_phone"> 负责人电话 </label>
                                        <div class="col-sm-9">
                                        <input type="text" id="director_phone" name="director_phone"  class="rcol-xs-10 col-sm-5" value="{{$data.director_phone|default:''}}">
                                            <span class="help-inline col-xs-12 col-sm-7"></span>
                                            </div>
                                        </div>
                                        <div class="space-4"></div>
                                             <h4 class="blue">
                                                <i class="green ace-icon fa fa-list bigger-110"></i>
                                               法人信息
                                            </h4>

                                            <div class="space-8"></div>
                                         <div class="form-group">
                                             <label class="col-sm-1 control-label no-padding-right" for="legal_name"> 法人姓名 </label>
                                        <div class="col-sm-9">
                                        <input type="text" id="legal_name" name="legal_name"  class="rcol-xs-10 col-sm-5" value="{{$data.legal_name|default:''}}">
                                            <span class="help-inline col-xs-12 col-sm-7"></span>
                                            </div>
                                        </div>
                                        <div class="space-4"></div>
                                        <div class="form-group">
                                             <label class="col-sm-1 control-label no-padding-right" for="legal_phone"> 法人电话 </label>
                                        <div class="col-sm-9">
                                        <input type="text" id="legal_phone" name="legal_phone"  class="rcol-xs-10 col-sm-5" value="{{$data.legal_phone|default:''}}">
                                            <span class="help-inline col-xs-12 col-sm-7"></span>
                                            </div>
                                        </div>
                                        <div class="space-4"></div>
                                            <h4 class="blue">
                                                <i class="green ace-icon fa fa-list bigger-110"></i>
                                               上传图片
                                            </h4>

                                            <div class="space-8"></div>
                                            <div class="form-group">

                                                <div class="col-sm-9">
                                                    <a href="javascript:" class="btn btn-white btn-xs btn-primary" onclick="triggerFileUpload(1)">上 传</a>


                                                </div>

                                            </div>
                                            <div class="form-group">


                                                <div class="col-sm-10">

                                                    <ul id="uploadImgcontainer" style="width: 95%">
                            {{if !empty($data.img) }}
                            {{foreach from=$data.img item=item}}
                            <li>
                                <img src="{{$item.img_path}}?imageView2/0/w/200/h/200/q/75|imageslim" alt="" style="height: 120px">
                                <span class="delete-this" onclick="del_pic(this);"><i></i></span>
                               <input type="hidden" name="pic_short[]" class="pic_short" value="{{$item.img_path}}">
                             
                            </li>
                            {{/foreach}}
                            {{/if}}
                                                    </ul>

                                                </div>

                                            </div>

                                        </div>

                                        <div id="faq-tab-2" class="tab-pane fade">
                                            <h4 class="blue">
                                                <i class="green ace-icon fa fa-user bigger-110"></i>
                                                执业经纪人
                                            </h4>

                                            <div class="space-8"></div>
                                            <div class="row">
                                                <div class="col-xs-9">
                                                    <div class="dataTables_filter">
                                                        <label>Add:<input type="text" id="search_" placeholder="执业证号">&nbsp;<a href="javascript:void(0);" id="btn_add_agent" class="btn btn-white btn-xs btn-primary">新 增</a></label>
                                                    </div>
                                                </div>
                                            </div>
                                             <div class="form-group">
                                           
                                        <div class="col-sm-9">
                                             <table class="table table-striped table-bordered">

                                <thead>

                                <tr>

                                    <th style="width:15%;">姓名</th>
                                    <th style="width:25%;">执业证号</th>

                                    <th style="width:25%;">身份证号</th>
                                    <th style="width:15%;">联系电话</th>
                                    <th style="width:10%;">网签</th>
                                     <th style="width:10%;">操作</th>
                                </tr>

                                </thead>

                                <tbody id="tbody_id">
                                    {{if !empty($data.agent) }}
                            {{foreach from=$data.agent item=item}}
                            <tr>
                                        <td>{{$item.name}}</td>
                                        <td>{{$item.job_code}}</td>
                                          <td>{{$item.card}}</td>
                                            <td>{{$item.phone}}</td>
                                            <td>
                                                <input type="hidden" name="setwq[]" value="{{if $item.wq == 2}}2{{else}}1{{/if}}">
                                                <input name="ckwq[]" {{if $item.wq == 2}} checked{{/if}} type="checkbox" />
                                            </td>
                                        <td>
                                            <input type="hidden" name="agent_job_code[]" value="{{$item.job_code}}">
                                            <input type="hidden" name="new_agent_id[]" value="{{$item.id}}">
                                            <a href="javascript:void(0);" dataid="" class="delete_yy_"><i class="ace-icon fa fa-trash bigger-100 red"></i>删除</a>
                                        </td>
                                    </tr>
                            {{/foreach}}
                            {{/if}}
                                  
                                </tbody>
                            </table>
                                            </div>
                                        </div>
                          
                                         
                                        </div>
                        
                                    </div>
                                </div>

                      

                            <div class="col-md-offset-2 col-md-9">
                                <button id="audit_btn" class="btn btn-info" type="button">

                                    <i class="icon-ok bigger-110"></i>

                                    提 审

                                </button>
                                &nbsp; &nbsp; &nbsp;
                                <a href="/manager/company_pending_3_list" class="btn" type="reset">

                                    <i class="icon-undo bigger-110"></i>

                                    返 回

                                </a>
                                &nbsp; &nbsp; &nbsp;
                                <button id="save_btn" class="btn btn-info" type="button">

                                    <i class="icon-ok bigger-110"></i>

                                    保 存

                                </button>
                            </div>
                        </form>
                        <!-- PAGE CONTENT ENDS -->
                    </div><!-- /.col -->
                </div><!-- /.row -->
            </div><!-- /.page-content -->
        </div>
    </div><!-- /.main-content -->
    {{include file='manager/public/footer.html'}}

</div><!-- /.main-container -->

{{include file='manager/public/footerjs.html'}}
<!-- inline scripts related to this page -->

<!--plupload start--------------------------------------------------------------------------->
<!-- Load plupload and all it's runtimes and finally the UI widget -->
<link rel="stylesheet" href="/manager_statics/plupload/js/jquery.ui.plupload/css/jquery.ui.plupload.css" type="text/css" />
<!-- production -->
<script type="text/javascript" src="/manager_statics/plupload/js/plupload.full.min.js"></script>
<script type="text/javascript" src="/manager_statics/plupload/js/zh_CN.js"></script>
<script type="text/javascript" src="/manager_statics/plupload/js/jquery.ui.plupload/jquery.ui.plupload.js"></script>
<!--plupload END--------------------------------------------------------------------------->

<script src="/manager_statics/qwadmin/js/date-time/bootstrap-datepicker.js"></script>
<script src="/manager_statics/app/ajaxfileupload.js"></script>
<script type="text/javascript">
    function triggerFileUpload(flag) {
        var data_ = "{{$f_user_id}}_{{$time}}_" + flag.toString() + "_" +  Math.floor(Math.random()*(9000)+1000);
        $("#folder").val(data_);
        var html = '<div id="uploader" style="width:550px;"><p>Your browser doesn\'t have Flash, Silverlight or HTML5 support.</p></div>';

        var layerIndex = layer.confirm(html, {
            offset: ['100px', (document.body.offsetWidth - 800) / 2],
            maxWidth: 800,
            btn: ['确定','取消'],
            shade: false
        }, function(){
            uploadFile(flag);
            layer.close(layerIndex);
        }, function(){
        });

        $("#uploader").plupload({
            runtimes : 'html5,flash,silverlight',
            url : "/manager_login/save_pics/company_pic/" + $("#folder").val(),
            max_file_size : '50mb',
            resize : { crop: true },
            file_data_name: 'userfile',
            filters : [],
            filters: {
                mime_types : [{
                    title : "Image files",
                    extensions : "jpg,gif,png,jpeg"
                }],
                max_file_size : '8024kb',
                prevent_duplicates : true
            },
            rename: true,
            sortable: true,
            dragdrop: true,
            views: {
                list: true,
                thumbs: true,
                active: 'thumbs'
            },
            flash_swf_url : '/manager_statics/plupload/js/Moxie.swf',
            silverlight_xap_url : '/manager_statics/plupload/js/Moxie.xap'
        });
    }

    function uploadFile(flag) {
        if ($('#uploader').plupload('getFiles').length < 1) {
            alert("图片未上传,请重新选择.");
            return false;
        } else {
            $.getJSON("/manager_login/get_pics/company_pic/" + $("#folder").val() +  "/?_=" + Math.random(), function(data){
                var html = '';
                var now_pic = [];
                $('input[name="pic_short[]"]').each(function(index){
                    now_pic[index] = $(this).val();
                });

                $.each(data.img,function(index,item){
                    var path = item + '?imageView2/0/w/200/h/200/q/75|imageslim';
                    if($.inArray(item, now_pic) < 0){
                        html += '<li><img src="' + path + '" alert="" style="height: 120px" />';
                        html += '<span class="delete-this" onclick="del_pic(this);"><i></i></span>';
                        html += '<input type="hidden" name="pic_short[]" class="pic_short" value="' + item + '">';
                        //html += '<input type="hidden" name="folder[]" value="'+ $("#folder").val() +'">';
                        html += '</li>';
                    }
                });
                $("#uploadImgcontainer").append(html);

            });
            return true;
        }
    }

    function del_pic(obj) {
        $(obj).parent().remove();
    }

    $("#audit_btn").click(function(){
        layer.confirm('是否确定提审!确定后将进入审核环节。', {
            btn: ['确定','取消'], //按钮
            area: ['400px', 'auto']
        }, function(){
            submit_fun('/manager/company_pending_3_submit');
        },function(){

        });
    })

    $("#save_btn").click(function(){
       layer.confirm('是否确定保存!终审完成状态进行保存将更新前台企业信息，将直接展示与游客。', {
            btn: ['确定','取消'], //按钮
            area: ['400px', 'auto']
        }, function(){
            submit_fun('/manager/company_pending_3_save');
        },function(){

        });
    })
    function submit_fun(url_submit){
         var company_name = $.trim($("#company_name").val());
        if(company_name == "" ) {
            layer.msg('企业名称不能为空', {icon: 2});
            return false;
        }
        var register_path = $.trim($("#register_path").val());
        if(register_path == "" ) {
            layer.msg('注册地址不能为空', {icon: 2});
            return false;
        }
        var business_path = $.trim($("#business_path").val());
        if(business_path == "" ) {
            layer.msg('经营地址不能为空', {icon: 2});
            return false;
        }
        var issuing_date = $.trim($("#issuing_date").val());
        if(issuing_date == "" ) {
            layer.msg('发证日期不能为空', {icon: 2});
            return false;
        }

         var company_phone = $.trim($("#company_phone").val());
        if(company_phone == "" ) {
            layer.msg('企业电话不能为空', {icon: 2});
            return false;
        }
         var director_name = $.trim($("#director_name").val());
        if(director_name == "" ) {
            layer.msg('负责人姓名不能为空', {icon: 2});
            return false;
        }
         var director_phone = $.trim($("#director_phone").val());
        if(director_phone == "" ) {
            layer.msg('负责人电话不能为空', {icon: 2});
            return false;
        }
         var legal_name = $.trim($("#legal_name").val());
        if(legal_name == "" ) {
            layer.msg('法人姓名不能为空', {icon: 2});
            return false;
        }
         var legal_phone = $.trim($("#legal_phone").val());
        if(legal_phone == "" ) {
            layer.msg('法人电话不能为空', {icon: 2});
            return false;
        }
        //报备时可以随意修改 审核时再做判断，以免在审核中有人员变动
        var length = $("#tbody_id").find(".delete_yy_").length;
        if(length < 3){
            //layer.msg('持证经纪人不能小于三个!', {icon: 2});
            //flag=1;return false;
        }
        $("#save_form").attr('action',url_submit);    //通过jquery为action属性赋值
        $("#save_form").submit();
    }
    

    $("#btn_add_agent").click(function(){
        var search_ = $.trim($("#search_").val());
        if (search_ == '') {
            layer.msg('请输入执业证号', {icon: 2});
            return false;
        }
        var flag_ = 1;
        $("[name='agent_job_code[]']").each(function(index2){
                        var code_2 = $.trim($(this).val());
                        if(code_2 != "" && code_2 == search_){
                                layer.alert('输入的执业证号已在列表中!', {skin: 'layui-layer-lan',closeBtn: 0,shift: 4 });
                                flag_ = 2;
                                return;
                        }
        })
        if (flag_ != 1) {
            return false;
        }

        var result = $.ajax({
            url : '/manager_login/show_agent4company_add/',
            data:{keyword:search_},
            cache : false,
            async : false,
            type : "POST"
        }).responseText;
        if(result == -1){
            layer.msg('页面信息过期,请刷新页面后查看!', {icon: 2});
            return false;
        }
        if(result == -2){
            layer.msg('未找到相关人员信息!', {icon: 2});
            return false;
        }
        var thisLayer = layer.confirm(result, {
            btn: ['关闭'], //按钮
            title:'执业经纪人信息',
            area: ['850px', 'auto']
        }, function(){
            layer.close(thisLayer)
        }
        );
    })

$("#tbody_id").on("click",".delete_yy_",function(){
     $(this).parent().parent().remove();
  });

 $("#tbody_id").on('click',"[name='ckwq[]']",function(){
           if($(this).is(':checked')){
               $(this).prev().val(2);
           }else{
               $(this).prev().val(1);
           }
       })
   
</script>
</body>
</html>
